{% extends "dashboard/base.html" %}

{% block title %}Apps - Dashboard{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-mobile-alt" aria-hidden="true"></i> Apps</h1>
    <div>
        {% if has_permission(CAN_REFRESH_PLAYSTORE) %}
        <form method="POST" action="{{ url_for('dashboard.fetch_all_info') }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-info mr-1" title="Fetch missing icons and descriptions from Play Store">
                <i class="fas fa-cloud-download-alt" aria-hidden="true"></i> Fetch Missing
            </button>
        </form>
        <form method="POST" action="{{ url_for('dashboard.fetch_all_info') }}" class="d-inline" id="fullRefreshAllForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="force" value="1">
            <button type="submit" class="btn btn-outline-warning mr-2" title="Full refresh all apps from Play Store (overwrites existing data)">
                <i class="fas fa-sync-alt" aria-hidden="true"></i> Full Refresh All
            </button>
        </form>
        {% endif %}
        {% if has_permission(CAN_ADD_APP) %}
        <a href="{{ url_for('dashboard.apps_add') }}" class="btn btn-primary">
            <i class="fas fa-plus" aria-hidden="true"></i> Add App
        </a>
        {% endif %}
    </div>
</div>

{% if apps %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>App Name</th>
                <th>Category</th>
                <th>Native App</th>
                <th>Reports</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for app in apps %}
            <tr>
                <td>
                    <strong>{{ app.android_name }}</strong>
                    {% if app.android_package %}
                    <br><small class="text-muted">{{ app.android_package }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if app.category and category_map.get(app.category) %}
                    <span class="category-badge">
                        <i class="fas {{ category_map[app.category].icon }}" aria-hidden="true"></i>
                        {{ category_map[app.category].name }}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if app.native_exists %}
                    <span class="badge badge-native">{{ app.native_name }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ app.reports_count or 0 }}</td>
                <td>
                    {% if has_permission(CAN_EDIT_APP) %}
                    <a href="{{ url_for('dashboard.apps_edit', app_id=app.id) }}" class="btn btn-sm btn-outline-primary" aria-label="Edit {{ app.android_name }}">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                    </a>
                    {% endif %}
                    {% if has_permission(CAN_DELETE_APP) %}
                    <form method="POST" action="{{ url_for('dashboard.apps_delete', app_id=app.id) }}" class="d-inline delete-form" data-confirm="Are you sure you want to delete this app?">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Delete {{ app.android_name }}">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </form>
                    {% endif %}
                    {% if not has_permission(CAN_EDIT_APP) and not has_permission(CAN_DELETE_APP) %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-mobile-alt" aria-hidden="true"></i>
    <h4>No apps yet</h4>
    {% if has_permission(CAN_ADD_APP) %}
    <p>Start by adding your first app to the database.</p>
    <a href="{{ url_for('dashboard.apps_add') }}" class="btn btn-primary">
        <i class="fas fa-plus" aria-hidden="true"></i> Add App
    </a>
    {% else %}
    <p>No apps have been added to the database yet.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
(function() {
    var deleteForms = document.querySelectorAll('.delete-form');
    for (var i = 0; i < deleteForms.length; i++) {
        deleteForms[i].addEventListener('submit', function(e) {
            var message = this.getAttribute('data-confirm') || 'Are you sure you want to delete this?';
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }

    // Full refresh all confirmation
    var fullRefreshAllForm = document.getElementById('fullRefreshAllForm');
    if (fullRefreshAllForm) {
        fullRefreshAllForm.addEventListener('submit', function(e) {
            if (!confirm('This will overwrite names, descriptions, and icons for ALL apps from the Play Store. This may take a while. Continue?')) {
                e.preventDefault();
            }
        });
    }
})();
</script>
{% endblock %}
