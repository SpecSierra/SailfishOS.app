{% extends "base.html" %}

{% block title %}{{ app.android_name }} - SailfishOS Compatibility{% endblock %}

{% block extra_css %}
<!-- hCaptcha -->
<script src="https://js.hcaptcha.com/1/api.js" async defer></script>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('frontend.index') }}">Apps</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ app.android_name }}</li>
    </ol>
</nav>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-start mb-4">
                    <div class="app-icon app-icon-lg mr-3">
                        {% if app.android_icon_url %}
                        <img src="{{ app.android_icon_url }}" alt="{{ app.android_name }}">
                        {% else %}
                        <i class="fab fa-android" aria-hidden="true"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="h2 mb-1">{{ app.android_name }}</h1>
                        {% if app.category and category_map.get(app.category) %}
                        <span class="category-badge">
                            <i class="fas {{ category_map[app.category].icon }}"></i>
                            {{ category_map[app.category].name }}
                        </span>
                        {% endif %}
                        {% if app.android_package %}
                        <p class="text-muted small mt-2 mb-0">
                            <i class="fas fa-cube"></i> {{ app.android_package }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                {% if app.android_description %}
                <p class="text-muted small">{{ app.android_description }}</p>
                {% endif %}

                <hr>

                <!-- SailfishOS Compatibility -->
                <h3 class="h5 mb-3">
                    <img src="{{ url_for('static', filename='icons/sailfishos-compatibility.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                    SailfishOS Compatibility
                </h3>

                <!-- Native App Section -->
                {% set all_native_apps = [] %}
                {% if app.native_exists and app.native_name %}
                    {% set _ = all_native_apps.append({'name': app.native_name, 'store_url': app.native_store_url, 'rating': app.native_rating}) %}
                {% endif %}
                {% for native_app in app.additional_native_apps %}
                    {% set _ = all_native_apps.append(native_app) %}
                {% endfor %}

                <div class="card mb-3 {% if all_native_apps %}border-info{% else %}border-secondary{% endif %}">
                    <div class="card-header {% if all_native_apps %}bg-info text-white{% else %}bg-light{% endif %}">
                        <img src="{{ url_for('static', filename='icons/sailfishos-mark.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                        Native App{% if all_native_apps|length > 1 %}s{% endif %}
                    </div>
                    <div class="card-body">
                        {% if all_native_apps %}
                        {% for native_app in all_native_apps %}
                        <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div>
                                <strong>{{ native_app.name }}</strong>
                                {% if native_app.store_url %}
                                <a href="{{ native_app.store_url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary ml-2">
                                    <i class="fas fa-external-link-alt"></i> Store
                                </a>
                                {% endif %}
                            </div>
                            {% if native_app.rating and native_app.rating != 'none' and native_app.rating != 0 %}
                            <span class="badge badge-tier-{{ native_app.rating }}">
                                <i class="fas fa-medal" aria-hidden="true"></i> {{ native_app.rating|capitalize }}
                            </span>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle"></i> No native SailfishOS app available
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Community Compatibility Ratings -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-chart-bar"></i> Community Compatibility Ratings
                        {% if report_count > 0 %}
                        <small class="ml-2">({{ report_count }} report{% if report_count != 1 %}s{% endif %})</small>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Android App Support -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="text-center p-3 border rounded h-100">
                                    <div class="mb-2">
                                        <i class="fab fa-android fa-2x text-success"></i>
                                    </div>
                                    <h6>Android App</h6>
                                    {% set android = platform_ratings.android %}
                                    {% if android.count > 0 %}
                                        {% if android.status == 'yes' %}
                                        <span class="badge badge-works badge-lg">
                                            <i class="fas fa-check"></i> Works
                                        </span>
                                        {% elif android.status == 'partial' %}
                                        <span class="badge badge-partial badge-lg">
                                            <i class="fas fa-exclamation"></i> Partial
                                        </span>
                                        {% elif android.status == 'no' %}
                                        <span class="badge badge-no badge-lg">
                                            <i class="fas fa-times"></i> No
                                        </span>
                                        {% endif %}
                                        <div class="small text-muted mt-2">
                                            {{ android.count }} report{% if android.count != 1 %}s{% endif %}
                                        </div>
                                        <div class="small mt-1">
                                            <span class="text-success">{{ android.works_count.yes }}</span> |
                                            <span class="text-warning">{{ android.works_count.partial }}</span> |
                                            <span class="text-danger">{{ android.works_count.no }}</span>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-unknown badge-lg">
                                            <i class="fas fa-question"></i> No data
                                        </span>
                                        <div class="small text-muted mt-2">No reports yet</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Native App -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="text-center p-3 border rounded h-100">
                                    <div class="mb-2">
                                        <img src="{{ url_for('static', filename='icons/sailfishos-mark.svg') }}" class="sfos-icon fa-2x" alt="" aria-hidden="true">
                                    </div>
                                    <h6>Native App</h6>
                                    {% set native = platform_ratings.native %}
                                    {% if native.count > 0 %}
                                        {% if native.status == 'yes' %}
                                        <span class="badge badge-works badge-lg">
                                            <i class="fas fa-check"></i> Works
                                        </span>
                                        {% elif native.status == 'partial' %}
                                        <span class="badge badge-partial badge-lg">
                                            <i class="fas fa-exclamation"></i> Partial
                                        </span>
                                        {% elif native.status == 'no' %}
                                        <span class="badge badge-no badge-lg">
                                            <i class="fas fa-times"></i> No
                                        </span>
                                        {% endif %}
                                        <div class="small text-muted mt-2">
                                            {{ native.count }} report{% if native.count != 1 %}s{% endif %}
                                        </div>
                                        <div class="small mt-1">
                                            <span class="text-success">{{ native.works_count.yes }}</span> |
                                            <span class="text-warning">{{ native.works_count.partial }}</span> |
                                            <span class="text-danger">{{ native.works_count.no }}</span>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-unknown badge-lg">
                                            <i class="fas fa-question"></i> No data
                                        </span>
                                        <div class="small text-muted mt-2">No reports yet</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Browser -->
                            <div class="col-md-4">
                                <div class="text-center p-3 border rounded h-100">
                                    <div class="mb-2">
                                        <i class="fas fa-globe fa-2x text-secondary"></i>
                                    </div>
                                    <h6>Web Browser</h6>
                                    {% set browser = platform_ratings.browser %}
                                    {% if browser.count > 0 %}
                                        {% if browser.status == 'yes' %}
                                        <span class="badge badge-works badge-lg">
                                            <i class="fas fa-check"></i> Works
                                        </span>
                                        {% elif browser.status == 'partial' %}
                                        <span class="badge badge-partial badge-lg">
                                            <i class="fas fa-exclamation"></i> Partial
                                        </span>
                                        {% elif browser.status == 'no' %}
                                        <span class="badge badge-no badge-lg">
                                            <i class="fas fa-times"></i> No
                                        </span>
                                        {% endif %}
                                        <div class="small text-muted mt-2">
                                            {{ browser.count }} report{% if browser.count != 1 %}s{% endif %}
                                        </div>
                                        <div class="small mt-1">
                                            <span class="text-success">{{ browser.works_count.yes }}</span> |
                                            <span class="text-warning">{{ browser.works_count.partial }}</span> |
                                            <span class="text-danger">{{ browser.works_count.no }}</span>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-unknown badge-lg">
                                            <i class="fas fa-question"></i> No data
                                        </span>
                                        <div class="small text-muted mt-2">No reports yet</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if app.android_support_notes or app.browser_notes %}
                        <div class="mt-3">
                            {% if app.android_support_notes %}
                            <div class="alert alert-secondary mb-2">
                                <strong><i class="fas fa-sticky-note"></i> Notes:</strong>
                                <p class="mb-0 mt-2">{{ app.android_support_notes }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Community Reports Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-users"></i> Community Reports ({{ reports|length }})
            </div>
            <div class="card-body">
                {% if reports %}
                    {% for report in reports %}
                    <div class="report-item border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ report.reporter_name or 'Anonymous' }}</strong>
                                <span class="text-muted small ml-2">{{ report.created_at[:10] if report.created_at else '' }}</span>
                            </div>
                            <div>
                                <!-- Platform badge -->
                                {% if report.platform == 'android' %}
                                <span class="badge badge-secondary mr-1"><i class="fab fa-android" aria-hidden="true"></i> Android</span>
                                {% elif report.platform == 'native' %}
                                <span class="badge badge-info mr-1"><i class="fas fa-ship" aria-hidden="true"></i> Native</span>
                                {% elif report.platform == 'browser' %}
                                <span class="badge badge-secondary mr-1"><i class="fas fa-globe" aria-hidden="true"></i> Browser</span>
                                {% endif %}
                                <!-- Works status -->
                                {% set works_status = report.works if report.works else report.android_support_works %}
                                {% if works_status == 'yes' %}
                                <span class="badge badge-works">Works</span>
                                {% elif works_status == 'partial' %}
                                <span class="badge badge-partial">Partial</span>
                                {% elif works_status == 'no' %}
                                <span class="badge badge-no">No</span>
                                {% else %}
                                <span class="badge badge-unknown">Unknown</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if report.device or report.sailfish_version or report.app_version %}
                        <div class="text-muted small mt-1">
                            {% if report.device %}<span class="mr-2"><i class="fas fa-mobile-alt" aria-hidden="true"></i> {{ report.device }}</span>{% endif %}
                            {% if report.sailfish_version %}
                            <span class="mr-2">
                                <img src="{{ url_for('static', filename='icons/sailfishos-compatibility.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                                {{ report.sailfish_version }}
                            </span>
                            {% endif %}
                            {% if report.app_version %}
                            <span>
                                <img src="{{ url_for('static', filename='icons/sailfishos-compatibility.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                                v{{ report.app_version }}
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Show dependency info (only for Android reports) -->
                        {% if report.platform == 'android' and report.dependency and report.dependency != 'none' %}
                        <div class="mt-1">
                            <span class="badge badge-warning">
                                <i class="fas fa-cog" aria-hidden="true"></i>
                                {% if report.dependency == 'microg' %}Requires microG
                                {% elif report.dependency == 'gapps' %}Requires GApps
                                {% elif report.dependency == 'microg_or_gapps' %}Requires microG/GApps{% endif %}
                            </span>
                        </div>
                        {% endif %}

                        {% if report.notes %}
                        <p class="mt-2 mb-0">{{ report.notes }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-muted mb-0">No community reports yet. Be the first to submit one!</p>
                {% endif %}
            </div>
        </div>

        <!-- Submit Report Form -->
        <div class="card mt-4" id="submit-report-card">
            <div class="card-header">
                <button class="btn collapse-toggle text-left w-100 p-0" type="button" data-toggle="collapse" data-target="#submit-report" aria-expanded="{{ 'true' if form.errors or not reports else 'false' }}" aria-controls="submit-report">
                    <i class="fas fa-plus-circle" aria-hidden="true"></i> Submit Your Report
                    <i class="fas fa-chevron-down float-right mt-1" aria-hidden="true"></i>
                </button>
            </div>
            <div id="submit-report" class="card-body collapse{% if form.errors or not reports %} show{% endif %}">
                <p class="text-muted">Have you tested this app on SailfishOS? Share your experience!</p>

                <form method="POST" action="{{ url_for('frontend.app_detail', app_id=app.id) }}">
                    {{ form.hidden_tag() }}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reporter_name"><i class="fas fa-user"></i> Your Name (optional)</label>
                                {{ form.reporter_name(class="form-control", placeholder="Anonymous") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="platform"><i class="fas fa-layer-group"></i> What are you testing? *</label>
                                {{ form.platform(class="form-control", id="platform-select") }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="works"><i class="fas fa-check-circle"></i> Does it work? *</label>
                                {{ form.works(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-6" id="dependency-group" style="display: none;">
                            <div class="form-group">
                                <label for="dependency"><i class="fas fa-cog"></i> Google Services Required?</label>
                                {{ form.dependency(class="form-control") }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="device"><i class="fas fa-mobile-alt"></i> Device</label>
                                {{ form.device(class="form-control", id="device-select") }}
                            </div>
                            <div class="form-group" id="custom-device-group" style="display: none;">
                                <label for="custom_device"><i class="fas fa-edit"></i> Custom Device Name</label>
                                {{ form.custom_device(class="form-control", placeholder="Enter your device name") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sailfish_version">
                                    <img src="{{ url_for('static', filename='icons/sailfishos-mark.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                                    SFOS Version
                                </label>
                                {{ form.sailfish_version(class="form-control", id="sfos-select") }}
                            </div>
                            <div class="form-group" id="custom-sfos-group" style="display: none;">
                                <label for="custom_sailfish_version"><i class="fas fa-edit"></i> Custom Version</label>
                                {{ form.custom_sailfish_version(class="form-control", placeholder="e.g., 4.5.0.18") }}
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="app_version">
                            <img src="{{ url_for('static', filename='icons/sailfishos-mark.svg') }}" class="sfos-icon mr-1" alt="" aria-hidden="true">
                            App/Client Version (optional)
                        </label>
                        {{ form.app_version(class="form-control", placeholder="e.g., 2.23.10") }}
                    </div>

                    <div class="form-group">
                        <label for="notes"><i class="fas fa-sticky-note"></i> Notes / Details</label>
                        {{ form.notes(class="form-control", rows=3, placeholder="Share any issues, workarounds, or tips...") }}
                    </div>

                    <!-- hCaptcha -->
                    <div class="form-group">
                        <div class="h-captcha" data-sitekey="{{ hcaptcha_site_key }}"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Information
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Category</dt>
                    <dd>
                        {% if app.category and category_map.get(app.category) %}
                        <i class="fas {{ category_map[app.category].icon }}"></i>
                        {{ category_map[app.category].name }}
                        {% else %}
                        Uncategorized
                        {% endif %}
                    </dd>

                    <dt>Community Reports</dt>
                    <dd><i class="fas fa-users"></i> {{ app.reports_count or 0 }} reports</dd>

                    {% if app.updated_at %}
                    <dt>Last Updated</dt>
                    <dd><i class="fas fa-clock"></i> {{ app.updated_at[:10] }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-lightbulb"></i> Quick Summary
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% if app.native_exists %}
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Native app available: <strong>{{ app.native_name }}</strong>
                    </li>
                    {% endif %}

                    {% if app.android_support_works == 'yes' %}
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Works via Android App Support
                    </li>
                    {% elif app.android_support_works == 'partial' %}
                    <li class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        Partial Android App Support
                    </li>
                    {% elif app.android_support_works == 'no' %}
                    <li class="mb-2">
                        <i class="fas fa-times text-danger"></i>
                        Does not work via Android App Support
                    </li>
                    {% else %}
                    <li class="mb-2">
                        <i class="fas fa-question text-muted"></i>
                        Android App Support status unknown
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <i class="fas fa-hand-pointer"></i> Contribute
            </div>
            <div class="card-body">
                <p class="small mb-0">
                    Have you tested <strong>{{ app.android_name }}</strong> on SailfishOS?
                    Help the community by submitting a compatibility report!
                </p>
                <a href="#submit-report-card" class="btn btn-outline-info btn-sm mt-2">
                    <i class="fas fa-plus" aria-hidden="true"></i> Add Report
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var platformSelect = document.getElementById('platform-select');
    var dependencyGroup = document.getElementById('dependency-group');
    var deviceSelect = document.getElementById('device-select');
    var customDeviceGroup = document.getElementById('custom-device-group');
    var sfosSelect = document.getElementById('sfos-select');
    var customSfosGroup = document.getElementById('custom-sfos-group');

    function toggleDependency() {
        if (platformSelect.value === 'android') {
            dependencyGroup.style.display = 'block';
        } else {
            dependencyGroup.style.display = 'none';
        }
    }

    function toggleCustomDevice() {
        if (deviceSelect.value === 'custom') {
            customDeviceGroup.style.display = 'block';
        } else {
            customDeviceGroup.style.display = 'none';
        }
    }

    function toggleCustomSfos() {
        if (sfosSelect.value === 'custom') {
            customSfosGroup.style.display = 'block';
        } else {
            customSfosGroup.style.display = 'none';
        }
    }

    // Initial check
    toggleDependency();
    toggleCustomDevice();
    toggleCustomSfos();

    // Listen for changes
    platformSelect.addEventListener('change', toggleDependency);
    deviceSelect.addEventListener('change', toggleCustomDevice);
    sfosSelect.addEventListener('change', toggleCustomSfos);
});
</script>
{% endblock %}
